name: security

on:
  push:
    paths:
      - '**/*.py'
      - 'Dockerfile'
      - 'k8s/**'
      - '.github/workflows/security.yml'
  pull_request:
  workflow_dispatch:

jobs:
  sca:
    name: SCA (SBOM + Grype)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.json
      - uses: anchore/scan-action@v3
        with:
          sbom: sbom.json
          fail-build: true
          severity-cutoff: high

  sast:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: returntocorp/semgrep-action@v1
        with:
          config: p/ci
          severity: high

  secrets:
    name: Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --exit-code 1

  policy:
    name: Policy / Container / IaC (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          severity: HIGH,CRITICAL
          exit-code: '1'
      - uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: s09s12-app:local
          severity: HIGH,CRITICAL
          exit-code: '1'

  dast:
    name: DAST (OWASP ZAP baseline)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start app
        run: |
          docker build -t s09s12-app:local .
          docker run -d --name web -p 8080:8080 s09s12-app:local
      - name: ZAP baseline
        run: |
          docker run --rm --network host owasp/zap2docker-stable \
            zap-baseline.py -t http://localhost:8080 -m 3
